<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clube VIP â€” Painel do Morador</title>
  <style>
    :root{
      --bg:#121212; --panel:#1c1c1f; --ink:#e8e8e8; --muted:#9aa0a6; --accent:#21c063; --danger:#ff5d5d;
      --input:#232327; --border:#2a2a2e;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:720px;margin:24px auto;padding:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{font-size:26px;margin:0 0 12px}
    label{display:block;margin:12px 0 6px;color:var(--muted)}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--input);color:var(--ink);outline:none}
    input::placeholder{color:#6c7278}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:680px){ .grid{grid-template-columns:1fr 1fr} }
    button{width:100%;border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer;background:#0f0f10;color:#fff}
    .btn{background:#0f0f10}
    .btn:hover{filter:brightness(1.1)}
    .ok{color:var(--accent)}
    .bad{color:var(--danger)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;background:#0f0f10;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .panel{background:#161618;border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Clube VIP â€” Painel do Morador</h1>

      <div class="grid">
        <div>
          <label for="vip">VIP ou Token</label>
          <input id="vip" placeholder="ex.: VIP001 ou gAbC123..." autocomplete="one-time-code" />
        </div>
        <div>
          <label for="pin">PIN do morador</label>
          <input id="pin" type="password" placeholder="PIN de 4â€“6 dÃ­gitos" />
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="btn" class="btn">Consultar</button>
      </div>

      <div id="msg" class="muted" style="margin-top:10px"></div>

      <div id="statusBox" class="panel" style="display:none">
        <div class="row">
          <span class="pill" id="vippill">VIP</span>
          <span class="pill" id="namepill">â€”</span>
        </div>
        <div style="margin-top:8px" id="statusLine">â€”</div>
        <div class="row" style="margin-top:8px">
          <div class="pill">Pontos: <b id="pontos">0</b></div>
          <div class="pill">Validade: <b id="valid">â€”</b></div>
          <div class="pill">Status: <b id="sts">â€”</b></div>
        </div>
      </div>

      <div id="histBox" class="panel" style="display:none">
        <div class="row" style="justify-content:space-between">
          <b>Ãšltimos usos</b>
          <span class="muted" id="count"></span>
        </div>
        <table id="hist">
          <thead><tr><th>Data</th><th>Parceiro</th><th>Oferta</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ðŸ”— SUA Web App /exec (ATENÃ‡ÃƒO: esta constante precisa existir com este nome)
    const APP_URL = "https://script.google.com/macros/s/AKfycbz-6HVoj0L_JyqCwaf-8Gn3Ye_ClEQMgSyqT7JQzoubFkF8XaB0OnrXL1oSbfEUx6Oipw/exec";

    const $ = (id)=>document.getElementById(id);
    const btn = $("btn"), vipEl = $("vip"), pinEl = $("pin"), msg = $("msg");

    // PrÃ©-preenche via ?vip= & ?pin=
    (function preload(){
      const u = new URL(location.href);
      const v = (u.searchParams.get("vip")||"").trim();
      const p = (u.searchParams.get("pin")||"").trim();
      if (v) vipEl.value = v;
      if (p) pinEl.value = p;
      if (v && p) consult();
    })();

    btn.addEventListener("click", consult);

    async function consult(){
      const vip = vipEl.value.trim();
      const pin = pinEl.value.trim();
      if (!vip || !pin){ flash("Informe VIP/Token e PIN.", true); return; }

      try{
        flash("Consultando...");
        const u = APP_URL + "?action=status&token=" + encodeURIComponent(vip) + "&pin=" + encodeURIComponent(pin);
        const r = await fetch(u, {method:"GET", credentials:"omit"});
        if(!r.ok) throw new Error("HTTP " + r.status);
        const j = await r.json();
        if(!j.ok){ flash(j.msg || "NÃ£o encontrado.", true); hideBoxes(); return; }

        // status
        $("vippill").textContent = j.numero || vip;
        $("namepill").textContent = j.nome || "â€”";
        $("valid").textContent = j.validade || "â€”";
        $("sts").textContent   = j.status || "â€”";
        $("pontos").textContent= (j.pontos!=null ? j.pontos : "0");
        $("statusLine").innerHTML = (j.ok ? '<span class="ok">âœ”</span> ' : '<span class="bad">âœ–</span> ') + (j.msg || "");
        $("statusBox").style.display = "block";
        flash("");

        // histÃ³rico
        await loadHistory(vip);
      }catch(err){
        flash("Falha de rede: " + (err.message||err), true);
        hideBoxes();
      }
    }

    async function loadHistory(vip){
      try{
        const url = APP_URL + "?action=meus-consumos&token=" + encodeURIComponent(vip);
        const r = await fetch(url, {method:"GET"});
        if(!r.ok) throw new Error("HTTP " + r.status);
        const data = await r.json();

        const tbody = $("hist").querySelector("tbody");
        tbody.innerHTML = "";
        let rows = [];

        // aceita vÃ¡rios formatos (array puro ou {items:[...]})
        if (Array.isArray(data) && data.length){
          rows = data;
        } else if (data && Array.isArray(data.items)) {
          rows = data.items;
        }

        rows.slice(0, 20).forEach(item=>{
          const tr = document.createElement("tr");
          const d  = fmtDate(item.timestamp || item.data || item.date);
          const pr = item.parceiro || item.parceiroID || "";
          const of = item.oferta || item.ofertaID || item.titulo || "";
          tr.innerHTML = `<td>${d}</td><td>${pr}</td><td>${escapeHtml(of)}</td>`;
          tbody.appendChild(tr);
        });

        $("count").textContent = rows.length ? `${rows.length} registro(s)` : "sem registros";
        $("histBox").style.display = "block";
      }catch(e){
        $("count").textContent = "histÃ³rico indisponÃ­vel";
        $("histBox").style.display = "block";
      }
    }

    function hideBoxes(){ $("statusBox").style.display = "none"; $("histBox").style.display = "none"; }
    function flash(txt, isErr){ msg.textContent = txt||""; msg.className = isErr ? "bad" : "muted"; }
    function fmtDate(d){
      if(!d) return "â€”";
      try{
        const x = (d instanceof Date) ? d : new Date(d);
        if (isNaN(x)) return String(d);
        return x.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric"});
      }catch(_){ return String(d); }
    }
    function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  </script>
</body>
</html>
