<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clube VIP</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
    .card { max-width: 520px; margin: auto; background: #fff; padding: 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.1); }
    h2 { margin-top: 0; }
    input, select, textarea, button { width: 100%; padding: 10px; margin: 6px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 15px; }
    button { background: #111; color: #fff; border: none; cursor: pointer; }
    button:hover { opacity: .9; }
    .msg { margin-top: 10px; font-size: 14px; }
    .ok { color: #0a7a3b; }
    .bad { color: #b00020; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Clube VIP</h2>
    <div id="parceiroInfo"></div>

    <label>PIN do parceiro</label>
    <input type="password" id="pin" placeholder="PIN">

    <label>Número VIP ou Token (ou cole link do QR)</label>
    <input id="codigo" placeholder="ex.: VIP001 ou gZjWpC607G">

    <button onclick="consultarStatus()">Consultar status</button>
    <div id="statusMsg" class="msg"></div>

    <div id="consumoArea" style="display:none">
      <label>Oferta</label>
      <select id="oferta"></select>

      <label>Atendente</label>
      <input id="atendente" placeholder="Nome do atendente">

      <label>Observação (opcional)</label>
      <textarea id="obs" rows="2"></textarea>

      <button onclick="registrarConsumo()">Registrar consumo</button>
      <div id="consumoMsg" class="msg"></div>
    </div>
  </div>

  <script>
    // === CONFIG: coloque seu Web App URL abaixo ===
    const API_URL = "https://script.google.com/macros/s/AKfycbyYICKpi1RdjJGJxanxe7yStnkL6MCr9VWgZR4OuLKRC6Hij3n5bWozLz6Bzi1_b_m93Q/exec";

    // pega ?parceiro= da URL
    const urlParams = new URL(window.location.href).searchParams;
    const parceiroID = urlParams.get("parceiro") || "P001";
    document.getElementById("parceiroInfo").innerText = "Painel do Parceiro (" + parceiroID + ")";

    async function consultarStatus(){
      const codigo = document.getElementById("codigo").value.trim();
      if(!codigo){ alert("Informe o número VIP ou token"); return; }

      const url = API_URL + "?action=status&token=" + encodeURIComponent(codigo);
      try {
        const resp = await fetch(url);
        const data = await resp.json();
        const el = document.getElementById("statusMsg");
        if(data.ok){
          el.className = "msg ok";
          el.textContent = data.msg;
          carregarOfertas();
          document.getElementById("consumoArea").style.display = "block";
        } else {
          el.className = "msg bad";
          el.textContent = data.msg || "Erro ao consultar";
          document.getElementById("consumoArea").style.display = "none";
        }
      } catch(err){
        document.getElementById("statusMsg").className = "msg bad";
        document.getElementById("statusMsg").textContent = "Falha de rede: " + err;
      }
    }

    async function carregarOfertas(){
      const url = API_URL + "?action=ofertas&parceiro=" + encodeURIComponent(parceiroID);
      try{
        const resp = await fetch(url);
        const data = await resp.json();
        const sel = document.getElementById("oferta");
        sel.innerHTML = "";
        data.forEach(o => {
          const opt = document.createElement("option");
          opt.value = o.OfertaID;
          opt.textContent = o.Titulo;
          sel.appendChild(opt);
        });
      }catch(e){
        console.error("Erro ao carregar ofertas", e);
      }
    }

    async function registrarConsumo(){
      const payload = {
        action: "salvar",
        parceiro: parceiroID,
        pin: document.getElementById("pin").value.trim(),
        token: document.getElementById("codigo").value.trim(),
        oferta: document.getElementById("oferta").value,
        atendente: document.getElementById("atendente").value.trim(),
        obs: document.getElementById("obs").value.trim()
      };
      try{
        const resp = await fetch(API_URL, {
          method: "POST",
          headers: {"Content-Type":"application/x-www-form-urlencoded"},
          body: new URLSearchParams(payload).toString()
        });
        const data = await resp.json();
        const el = document.getElementById("consumoMsg");
        if(data.ok){
          el.className = "msg ok";
          el.textContent = data.msg;
        } else {
          el.className = "msg bad";
          el.textContent = data.msg || "Erro ao registrar";
        }
      }catch(e){
        document.getElementById("consumoMsg").className = "msg bad";
        document.getElementById("consumoMsg").textContent = "Falha: " + e;
      }
    }
  </script>
</body>
</html>
