<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clube VIP</title>
  <!-- VERSAO 12 -->
  <style>
    :root{--fg:#111;--muted:#666;--ok:#0a7a3b;--bad:#b00020;--bd:#ddd;}
    body{font-family:Arial, sans-serif; margin:20px; color:var(--fg);}
    .card{max-width:680px;margin:auto;border:1px solid var(--bd);border-radius:12px;padding:16px}
    label{font-weight:bold;margin-top:10px;display:block}
    input,select,textarea,button{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:8px}
    button{background:#111;color:#fff;border:none;cursor:pointer}
    .ok{color:var(--ok);font-weight:bold}
    .bad{color:var(--bad);font-weight:bold}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px}
    .row > * {flex:1}
  </style>
</head>
<body>
  <div class="card">
    <h2>Clube VIP</h2>
    <p id="modo">Carregando…</p>

    <!-- Painel do parceiro -->
    <div id="painel-parceiro" style="display:none">
      <div class="row">
        <div>
          <label>PIN do parceiro</label>
          <input id="pin" type="password" placeholder="PIN"/>
        </div>
        <div>
          <label>Número VIP ou Token (ou cole o link do QR)</label>
          <input id="entrada" placeholder="ex.: VIP001 ou gZjWpC607G ou ...?t=gZjWpC607G"/>
        </div>
      </div>

      <div class="row">
        <button onclick="consultar()">Consultar status</button>
      </div>
      <div id="status" class="muted"></div>

      <div id="registro" style="display:none">
        <label>Oferta</label>
        <select id="oferta"></select>

        <label>Atendente</label>
        <input id="atendente" placeholder="Nome do atendente"/>

        <label>Observação (opcional)</label>
        <textarea id="obs" rows="2"></textarea>

        <button onclick="enviar()">Registrar consumo</button>
      </div>

      <div id="msg" class="muted"></div>
    </div>

    <!-- Painel simples de status (quando vem ?t=TOKEN) -->
    <div id="painel-status" style="display:none">
      <h3>Status da carteirinha</h3>
      <div id="status-simples" class="muted"></div>
    </div>
  </div>

  <script>
    /* ====== CONFIG ====== */
    // URL DO SEU APPS SCRIPT (/exec)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyYICKpi1RdjJGJxanxe7yStnkL6MCr9VWgZR4OuLKRC6Hij3n5bWozLz6Bzi1_b_m93Q/exec";

    // Proxy para contornar CORS (GET e POST)
    const viaProxy = (url) => "https://corsproxy.io/?" + encodeURIComponent(url);

    /* ====== MODO DE TELA ====== */
    const params = new URLSearchParams(window.location.search);
    const parceiro = params.get("parceiro");
    const token = params.get("t");
    const page = params.get("page");

    if (page === "registrar" && parceiro) {
      document.getElementById("modo").innerText = "Painel do Parceiro ("+parceiro+")";
      document.getElementById("painel-parceiro").style.display = "block";
      carregarOfertas(parceiro);
    } else if (token) {
      document.getElementById("modo").innerText = "Status do Morador";
      document.getElementById("painel-status").style.display = "block";
      consultarStatusSimples(token);
    } else {
      document.getElementById("modo").innerText = "Use ?t=TOKEN ou ?page=registrar&parceiro=P001";
    }

    /* ====== FUNÇÕES ====== */
    // Carrega ofertas do parceiro
    async function carregarOfertas(parceiroID){
      const sel = document.getElementById("oferta");
      sel.innerHTML = "";
      try{
        const url = SCRIPT_URL + "?action=ofertas&parceiro=" + encodeURIComponent(parceiroID);
        const r = await fetch(viaProxy(url), { cache: "no-store" });
        const txt = await r.text();
        let j = null; try { j = JSON.parse(txt); } catch(_){}
        if(!r.ok) throw new Error("HTTP " + r.status + " – " + txt.slice(0,200));
        if(!Array.isArray(j)) throw new Error("Resposta inválida de ofertas: " + txt.slice(0,200));
        j.forEach(o=>{
          const opt = document.createElement("option");
          opt.value = o.OfertaID;
          opt.textContent = o.Titulo;
          sel.appendChild(opt);
        });
      }catch(err){
        sel.innerHTML = "";
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Erro ao carregar ofertas: " + err.message;
        sel.appendChild(opt);
      }
    }

    // Consulta status (VIP/token/link)
    async function consultar(){
      const q = document.getElementById("entrada").value.trim();
      const box = document.getElementById("status");
      if(!q){ alert("Digite o número VIP, token ou cole o link do QR"); return; }
      box.className = "muted";
      box.textContent = "Consultando…";
      try{
        const url = SCRIPT_URL + "?action=status&q=" + encodeURIComponent(q);
        const r = await fetch(viaProxy(url), { cache: "no-store" });
        const txt = await r.text();
        let j = null; try { j = JSON.parse(txt); } catch(_){}
        if(!r.ok){
          box.className = "bad";
          box.textContent = "Erro HTTP " + r.status + " – " + txt.slice(0,200);
          document.getElementById("registro").style.display="none";
          return;
        }
        if(j && typeof j === "object"){
          if(j.ok){
            box.className = "ok";
            box.textContent = (j.msg||"Válida")
                              + (j.numero?(" — "+j.numero):"")
                              + (j.nome?(" — "+j.nome):"")
                              + (j.validade?(" — até "+j.validade):"");
            document.getElementById("registro").style.display = "block";
          } else {
            box.className = "bad";
            box.textContent = j.msg || "Inválido";
            document.getElementById("registro").style.display = "none";
          }
        } else {
          box.className = "bad";
          box.textContent = "Resposta não-JSON: " + txt.slice(0,200);
          document.getElementById("registro").style.display="none";
        }
      }catch(err){
        box.className = "bad";
        box.textContent = "Falha de rede: " + err.message;
        document.getElementById("registro").style.display="none";
      }
    }

    // Registrar consumo
    async function enviar(){
      const pin = document.getElementById("pin").value.trim();
      const entrada = document.getElementById("entrada").value.trim();
      const oferta = document.getElementById("oferta").value;
      const atendente = document.getElementById("atendente").value.trim();
      const obs = document.getElementById("obs").value.trim();
      const el = document.getElementById("msg");

      if(!pin){ alert("Informe o PIN."); return; }
      if(!entrada){ alert("Informe Número VIP, Token ou link do QR."); return; }
      if(!oferta){ alert("Escolha uma oferta."); return; }

      el.className = "muted";
      el.textContent = "Enviando…";
      try{
        const body = new URLSearchParams({
          action: "salvar",
          parceiro: parceiro || "",
          pin, token: entrada, oferta, atendente, obs
        }).toString();

        // POST via proxy também
        const proxyPost = viaProxy(SCRIPT_URL);
        const r = await fetch(proxyPost, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });

        const txt = await r.text();
        let j = null; try { j = JSON.parse(txt); } catch(_){}
        if(!r.ok){
          el.className = "bad";
          el.textContent = "Erro HTTP " + r.status + " – " + txt.slice(0,200);
          return;
        }
        if(j && j.ok){
          el.className = "ok";
          el.textContent = j.msg || "OK";
          document.getElementById("obs").value = "";
        } else {
          el.className = "bad";
          el.textContent = (j && j.msg) ? j.msg : ("Resposta não-JSON: " + txt.slice(0,200));
        }
      }catch(err){
        el.className = "bad";
        el.textContent = "Falha de rede: " + err.message;
      }
    }

    // Status simples (?t=TOKEN)
    async function consultarStatusSimples(token){
      const box = document.getElementById("status-simples");
      box.className = "muted";
      box.textContent = "Consultando…";
      try{
        const url = SCRIPT_URL + "?action=status&q=" + encodeURIComponent(token);
        const r = await fetch(viaProxy(url), { cache: "no-store" });
        const txt = await r.text();
        let j = null; try { j = JSON.parse(txt); } catch(_){}
        if(!r.ok){
          box.className = "bad";
          box.textContent = "Erro HTTP " + r.status + " – " + txt.slice(0,200);
          return;
        }
        if(j && j.ok){
          box.className = "ok";
          box.textContent = (j.msg||"Válida")
                            + (j.numero?(" — "+j.numero):"")
                            + (j.nome?(" — "+j.nome):"")
                            + (j.validade?(" — até "+j.validade):"");
        } else {
          box.className = "bad";
          box.textContent = (j && j.msg) ? j.msg : ("Resposta não-JSON: " + txt.slice(0,200));
        }
      }catch(err){
        box.className = "bad";
        box.textContent = "Falha de rede: " + err.message;
      }
    }
  </script>
</body>
</html>
