<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clube VIP — Painel do Parceiro</title>

  <style>
    :root { color-scheme: only dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b0b0c;
      color: #e9e9ea;
    }
    .wrap { max-width: 860px; margin: 24px auto; padding: 16px; }
    .card {
      background: #141416;
      border: 1px solid #232327;
      border-radius: 16px;
      padding: 18px 18px 22px 18px;
      box-shadow: 0 0 0 1px rgba(0,0,0,.04) inset;
    }
    h1 { margin: 0 0 8px 0; font-weight: 800; letter-spacing: .2px; }
    .muted { color: #a2a2a8; font-size: 13px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 14px; }
    @media (min-width: 740px) { .row-2 { grid-template-columns: 1fr 1fr; } }

    label { font-size: 13px; color: #cfcfd6; display: block; margin-bottom: 3px; }
    input, select, textarea {
      width: 100%; padding: 10px 12px; border-radius: 8px;
      border: 1px solid #2f2f33; background: #1a1a1d; color: #fff;
    }
    button {
      width: 100%; margin-top: 16px;
      padding: 12px; border: none; border-radius: 10px;
      background: #000; color: #fff; font-weight: bold;
      cursor: pointer; transition: all .2s;
    }
    button:hover { background: #111; }
    .status { margin-top: 12px; font-size: 14px; }
    .ok { color: #4ade80; }
    .err { color: #f87171; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Clube VIP</h1>
      <div id="painel"></div>
    </div>
  </div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxxNuxW645VEwsbrBLz8WzyPUVsrr2WV3eL_ARgEZX8E1JWDuyjHEKi30mk6B2XwxlcRg/exec";

// obtém parceiro da URL
const urlParams = new URLSearchParams(window.location.search);
const parceiro = urlParams.get("parceiro") || "P001";

// renderiza o formulário
document.getElementById("painel").innerHTML = `
  <div class="muted">Painel do Parceiro (${parceiro})</div>
  <div class="row row-2">
    <div>
      <label>PIN do parceiro</label>
      <input type="password" id="pinParceiro" placeholder="••••">
    </div>
    <div>
      <label>Número VIP ou Token</label>
      <input id="token" placeholder="ex.: VIP001">
    </div>
  </div>
  <button onclick="consultarStatus()">Consultar status</button>
  <div id="statusBox" class="status"></div>
  <div id="ofertaBox" style="display:none; margin-top:20px;">
    <label>Oferta</label>
    <select id="ofertaSelect"></select>
    <label>Atendente</label>
    <input id="atendente" placeholder="Nome do atendente">
    <label>Observação (opcional)</label>
    <input id="obs">
    <button onclick="registrarConsumo()">Registrar consumo</button>
    <div id="msgReg" class="status"></div>
  </div>
`;

async function consultarStatus(){
  const token = document.getElementById("token").value.trim();
  if(!token){ alert("Informe o número VIP!"); return; }

  document.getElementById("statusBox").innerHTML = "Consultando...";

  try {
    const r = await fetch(`${API}?action=status&token=${encodeURIComponent(token)}`);
    const data = await r.json();

    if(data.ok){
      document.getElementById("statusBox").innerHTML =
        `<span class="ok">${data.msg}</span>`;
      // buscar ofertas
      carregarOfertas(parceiro, token);
    } else {
      document.getElementById("statusBox").innerHTML =
        `<span class="err">${data.msg}</span>`;
    }
  } catch(e){
    document.getElementById("statusBox").innerHTML =
      `<span class="err">Erro: ${e}</span>`;
  }
}

async function carregarOfertas(parceiro, token){
  try {
    const r = await fetch(`${API}?action=ofertas&parceiro=${parceiro}&token=${token}`);
    const data = await r.json();

    const sel = document.getElementById("ofertaSelect");
    sel.innerHTML = "";

    if(data.ok && data.ofertas && data.ofertas.length > 0){
      data.ofertas.forEach(o=>{
        const opt = document.createElement("option");
        opt.value = o.nome;
        opt.textContent = `${o.nome} (${o.descricao||''})`;
        sel.appendChild(opt);
      });
      document.getElementById("ofertaBox").style.display = "block";
    } else {
      sel.innerHTML = `<option>— Nenhuma oferta ativa —</option>`;
      document.getElementById("ofertaBox").style.display = "block";
    }
  } catch(e){
    console.error(e);
  }
}

async function registrarConsumo(){
  const token = document.getElementById("token").value.trim();
  const oferta = document.getElementById("ofertaSelect").value;
  const atendente = document.getElementById("atendente").value;
  const obs = document.getElementById("obs").value;
  const pin = document.getElementById("pinParceiro").value;

  document.getElementById("msgReg").innerHTML = "Registrando...";

  try {
    const r = await fetch(API, {
      method:"POST",
      body: new URLSearchParams({
        action:"registrar",
        parceiro, token, oferta, atendente, obs, pin
      })
    });
    const data = await r.json();
    if(data.ok){
      document.getElementById("msgReg").innerHTML = `<span class="ok">${data.msg}</span>`;
    } else {
      document.getElementById("msgReg").innerHTML = `<span class="err">${data.msg}</span>`;
    }
  } catch(e){
    document.getElementById("msgReg").innerHTML = `<span class="err">Erro: ${e}</span>`;
  }
}
</script>
</body>
</html>
